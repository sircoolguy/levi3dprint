<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Levi 3D Print</title>
  
  <!-- 1. PASTE YOUR IMAGE STRING HERE (for the browser tab) -->
  <link rel="icon" type="image/png" id="faviconLink" href="">
  
  <style>
    /* General layout */
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      color: white;
      /* Dark blue background to make the wave stand out */
      background: #0a3d62; 
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Header */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      position: relative;
      z-index: 10;
    }

    .logo {
      width: 160px;
      margin-bottom: 10px;
      /* UPDATED: Removed the white background to fix 'white-on-white' */
      /* background: #fff; */ 
      border-radius: 50%; /* Kept this to make the shadow circular */
      /* padding: 10px; */ /* Removed padding */
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Added: Ensure container is transparent */
      background: transparent; 
    }

    /* UPDATED: Let the image fill the container and give it rounded corners */
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* Ensures your logo fits cleanly */
      border-radius: 8px; /* Give your logo image soft corners */
    }
    
    .logo-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #ff6600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* Tabs */
    nav {
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 15px;
      border-radius: 10px;
    }

    /* NEW: Style for the Change Logo button */
    #changeLogoButton {
      display: none; /* Hidden by default */
      margin-bottom: 15px;
      padding: 8px 15px;
      background: #ffc107;
      color: #333;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    #changeLogoButton:hover {
      background: #e0a800;
    }

    nav .tab {
      background: #0a3d62;
      border: none;
      color: white;
      font-size: 16px;
      padding: 8px 18px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    nav .tab:hover,
    nav .tab.active {
      background: #1e90ff;
    }

    /* Main content */
    main {
      text-align: center;
      margin-top: 50px;
      padding: 0 20px;
      position: relative;
      z-index: 10;
    }

    section {
      display: none;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 12px;
      max-width: 800px;
      margin: 0 auto;
    }

    section.active {
      display: block;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    
    p {
      font-size: 1.1em;
      line-height: 1.6;
    }

    /* Gallery */
    #gallery-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
      min-height: 150px; /* Ensure it has height even when empty */
    }
    
    /* Loading/Error state message */
    #gallery-status {
      font-size: 1.2em;
      color: #ffb347;
      width: 100%;
    }

    .image-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      overflow: hidden;
      background: #333;
    }

    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .image-wrapper:hover img {
      transform: scale(1.05);
    }

    .delete-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: none; /* Hidden by default */
      z-index: 5;
      opacity: 0.9;
      transition: opacity 0.2s;
    }
    
    .delete-btn:hover {
      opacity: 1;
    }

    /* Upload area */
    .upload-area {
      margin: 20px 0;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    #imageUpload {
      display: none; /* Hidden by default */
      margin-right: 10px;
    }
    
    #upload-label {
      display: none; /* Hidden by default */
      padding: 10px 15px;
      background: #1e90ff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    #upload-label:hover {
      background: #007bff;
    }
    
    #upload-status {
      display: inline-block;
      margin-left: 10px;
      font-size: 0.9em;
      min-height: 1.2em;
    }

    /* Footer */
    footer {
      text-align: center;
      position: relative;
      bottom: 5px;
      width: 100%;
      font-size: 13px;
      color: white;
      margin-top: 50px;
      padding-bottom: 10px;
      z-index: 10;
    }
    
    #userIdDisplay {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-top: 5px;
    }

    /* Owner button */
    #ownerButton {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #0a3d62;
      border: 2px solid white;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      z-index: 1000;
      transition: background 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    #ownerButton:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    #ownerButton:not(:disabled):hover {
      background: #1e90ff;
    }

    /* Wave background */
    .wave {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 120%;
      
      /* NEW: Complex, larger gradient */
      background: linear-gradient(135deg, #ff4500, #ff0000, #ff8c00, #ff6600, #ff4500);
      background-size: 400% 400%; /* Make the gradient much larger */
      
      clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
      z-index: -1;
      
      /* NEW: Slower fade animation */
      animation: waveMotion 6s ease-in-out infinite alternate,
        moveFade 15s ease-in-out infinite;
    }

    @keyframes waveMotion {
      0% {
        clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
      }
      50% {
        clip-path: polygon(0 0, 100% 0, 100% 92%, 0 98%);
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 95%, 0 90%);
      }
    }
    
    /* NEW: Keyframes for the larger gradient */
    @keyframes moveFade {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1e272e;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      text-align: center;
      width: 90%;
      max-width: 400px;
    }
    
    .modal-content h2 {
      margin-top: 0;
      color: #fff;
    }
    
    .modal-content p {
      color: #ccc;
      margin-bottom: 20px;
    }

    .modal-input {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
      border: 1px solid #555;
      background: #333;
      color: white;
      font-size: 16px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .modal-buttons button.confirm {
      background: #1e90ff;
      color: white;
    }

    .modal-buttons button.cancel {
      background: #555;
      color: white;
    }
    
  </style>
</head>
<body>
  <header>
    <!-- 2. PASTE YOUR IMAGE STRING HERE (for the main logo) -->
    <div class="logo" title="Levi 3D Print">
      <img src="https://placehold.co/160x160/FFFFFF/0a3d62?text=L3D" alt="L3D Logo" id="mainLogoImage">
    </div>
    <nav>
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="about">About</button>
      <button class="tab" data-tab="gallery">Gallery</button>
    </nav>
    <!-- NEW: Add a hidden file input for the logo -->
    <input type="file" id="logoUploadInput" accept="image/*" style="display: none;" />
    <!-- NEW: Add the button to change the logo -->
    <button id="changeLogoButton">Change Logo</button>
  </header>

  <!-- Wave background -->
  <div class="wave"></div>

  <main>
    <section id="home" class="active">
      <h1>Welcome to Levi 3D Print</h1>
      <p>Custom 3D printed creations designed with care and creativity.
      <br>The best part: I can customize almost everything!</p>
    </section>

    <section id="about">
      <h1>About Us</h1>
      <p>At Levi 3D Print, we specialize in custom designs and innovative prints made for you.
      <br>I can make earrings, toys, models, cars, keychains.
      <br>Contact me on Facebook @ levi's custom 3d printing or email me at levitaba6@icloud.com</p>
    </section>

    <section id="gallery">
      <h1>Gallery</h1>
      <div class="upload-area" id="uploadArea">
        <label for="imageUpload" id="upload-label">Choose File</label>
        <input type="file" id="imageUpload" accept="image/*" />
        <span id="upload-status"></span>
      </div>
      <div id="gallery-container">
        <!-- Images will be loaded here -->
        <p id="gallery-status">Loading gallery...</p>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 Levi 3D Print. All rights reserved.</p>
    <div id="userIdDisplay">Connecting...</div>
  </footer>

  <button id="ownerButton" disabled>Loading...</button>
  
  <!-- Custom Modal -->
  <div id="customModal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modalTitle">Modal Title</h2>
      <p id="modalMessage">This is the modal message.</p>
      <input type="password" id="modalInput" class="modal-input" style="display: none;" />
      <div class="modal-buttons">
        <button id="modalCancel" class="cancel">Cancel</button>
        <button id="modalConfirm" class="confirm">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
    <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, addDoc, deleteDoc, onSnapshot, 
      collection, setLogLevel as setFirestoreLogLevel, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // Import Storage SDK
    import { 
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ------------------------------------------------------------------
    // STEP 1: PASTE YOUR FIREBASE CONFIG HERE
    // This config is from your Firebase project (Project settings > General > Your apps)
    // ------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAWYZGZ8nvgSAgpQ60OsLqathduMM2CbQE",
      authDomain: "levi3dprint-94bb0.firebaseapp.com",
      projectId: "levi3dprint-94bb0",
      storageBucket: "levi3dprint-94bb0.appspot.com",
      messagingSenderId: "1044564863427",
      appId: "1:1044564863427:web:37017271e5972aee7c3576",
      measurementId: "G-08JB2G438T"
    };
    // ------------------------------------------------------------------

    // ======= App Elements =======
    const tabs = document.querySelectorAll(".tab");
    const sections = document.querySelectorAll("section");
    const ownerButton = document.getElementById("ownerButton");
    const uploadArea = document.getElementById("uploadArea");
    const uploadInput = document.getElementById("imageUpload");
    const uploadLabel = document.getElementById("upload-label");
    const uploadStatus = document.getElementById("upload-status");
    const gallery = document.getElementById("gallery-container");
    const galleryStatus = document.getElementById("gallery-status");
    const userIdDisplay = document.getElementById("userIdDisplay");
    
    // Modal Elements
    const customModal = document.getElementById("customModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalInput = document.getElementById("modalInput");
    const modalCancel = document.getElementById("modalCancel");
    const modalConfirm = document.getElementById("modalConfirm");
    // NEW: Add elements for logo
    const changeLogoButton = document.getElementById("changeLogoButton");
    const logoUploadInput = document.getElementById("logoUploadInput");
    const mainLogoImage = document.getElementById("mainLogoImage");
    const faviconLink = document.getElementById("faviconLink");

    // ======= App State =======
    let ownerMode = false;
    let currentUserId = null;
    let db, auth, storage;
    let galleryCollectionRef = null;
    let modalConfirmCallback = null;
    let imagesOnPage = new Map(); // To track images being displayed
    // NEW: Add state for logo
    let logoDocRef = null;
    let currentLogoStoragePath = null;
    const placeholderLogoUrl = "https://placehold.co/160x160/FFFFFF/0a3d62?text=L3D";

    // ======= Tabs =======
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });
    
    // --- Helper to show errors on screen ---
    function showOnScreenError(title, message) {
        gallery.innerHTML = ''; // Clear gallery
        galleryStatus.textContent = `${title} ${message}`;
        galleryStatus.style.color = "#ff6b6b"; // Red color
    }

    // --- Modal Functions (Replaces alert/prompt) ---
    function showMessage(message, title = "Notice") {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalInput.style.display = "none";
      modalCancel.style.display = "none";
      modalConfirm.textContent = "OK";
      customModal.style.display = "flex";
      
      modalConfirmCallback = () => {
        customModal.style.display = "none";
      };
    }

    function showConfirm(message, title, confirmText, callback) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalInput.style.display = "none";
      modalCancel.style.display = "inline-block";
      modalConfirm.textContent = confirmText;
      customModal.style.display = "flex";

      modalConfirmCallback = callback;
    }

    function showPrompt(message, title, callback) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalInput.value = "";
      modalInput.style.display = "block";
      modalCancel.style.display = "inline-block";
      modalConfirm.textContent = "Submit";
      customModal.style.display = "flex";

      modalConfirmCallback = () => {
        callback(modalInput.value);
      };
    }

    modalConfirm.addEventListener("click", () => {
      if (modalConfirmCallback) {
        modalConfirmCallback();
      }
      // Hide modal by default if callback didn't (e.g., in showMessage)
      if (modalInput.style.display === "none" && modalCancel.style.display === "none") {
         customModal.style.display = "none";
      }
    });

    modalCancel.addEventListener("click", () => {
      customModal.style.display = "none";
    });

    // ======= Owner system =======
    ownerButton.addEventListener("click", () => {
      if (!ownerMode) {
        showPrompt("Enter owner password:", "Owner Login", (password) => {
          if (password === "custom3dlevi") {
            ownerMode = true;
            showMessage("Owner mode activated!", "Success");
            uploadArea.style.display = "block";
            uploadLabel.style.display = "inline-block";
            changeLogoButton.style.display = "inline-block"; // Show button
            updateDeleteButtons();
            customModal.style.display = "none";
          } else {
            showMessage("Incorrect password! Not signed in.", "Error");
            ownerMode = false;
            uploadArea.style.display = "none";
            uploadLabel.style.display = "none";
            changeLogoButton.style.display = "none"; // Hide button
            updateDeleteButtons();
          }
        });
      } else {
        ownerMode = false;
        showMessage("Signed out of Owner mode.", "Signed Out");
        uploadArea.style.display = "none";
        uploadLabel.style.display = "none";
        changeLogoButton.style.display = "none"; // Hide button
        updateDeleteButtons();
      }
    });

    // ======= Gallery Functions (Now with Storage + Firestore) =======
    
    // This function adds an image to the page
    function addImageToPage(docId, imageUrl, storagePath) {
      if (imagesOnPage.has(docId)) return; // Already on page

      // Hide the "loading" or "empty" message
      if (galleryStatus) galleryStatus.style.display = "none";

      const wrapper = document.createElement("div");
      wrapper.classList.add("image-wrapper");
      wrapper.setAttribute('data-doc-id', docId);

      const img = document.createElement("img");
      img.src = imageUrl;
      img.onerror = () => {
        img.src = `https://placehold.co/200x200/FF6600/FFFFFF?text=Error&font=poppins`;
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "×";
      deleteBtn.classList.add("delete-btn");
      deleteBtn.style.display = ownerMode ? "block" : "none";

      deleteBtn.addEventListener("click", () => {
        showConfirm("Are you sure you want to delete this image?", "Delete Image", "Delete", async () => {
          customModal.style.display = "none";
          
          try {
            // 1. Delete the Firestore document
            const docRef = doc(db, "galleryImages", docId);
            await deleteDoc(docRef);
            
            // 2. Delete the file from Storage
            const fileRef = ref(storage, storagePath);
            await deleteObject(fileRef);
            
            // The onSnapshot listener will handle removing it from the page
            showMessage("Image deleted successfully!", "Success");

          } catch (error) {
            console.error("Error deleting image: ", error);
            showMessage(`Error deleting image: ${error.message}`, "Error");
          }
        });
      });

      wrapper.appendChild(img);
      wrapper.appendChild(deleteBtn);
      gallery.appendChild(wrapper);
      imagesOnPage.set(docId, wrapper); // Track the element
    }
    
    // This function removes an image from the page
    function removeImageFromPage(docId) {
      const wrapper = imagesOnPage.get(docId);
      if (wrapper) {
        wrapper.remove();
        imagesOnPage.delete(docId);
      }
      
      // Show message if gallery is now empty
      if (imagesOnPage.size === 0) {
        if (galleryStatus) {
            galleryStatus.textContent = "No images in gallery yet. Upload one!";
            galleryStatus.style.display = "block";
            galleryStatus.style.color = "#ffb347";
        }
      }
    }

    // --- Handle File Upload ---
    uploadInput.addEventListener("change", async () => {
      const file = uploadInput.files[0];
      if (!file) return;

      if (!ownerMode) {
        showMessage("You must be in Owner mode to upload!", "Error");
        return;
      }
      
      // Set status to uploading
      uploadStatus.textContent = "Uploading 0%...";
      uploadLabel.style.display = "none";

      try {
        // 1. Create a unique file name for Storage
        const storagePath = `images/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, storagePath);

        // 2. Upload the file to Firebase Storage
        // We're not using upload tasks for simplicity, but you could for progress
        const snapshot = await uploadBytes(storageRef, file);
        uploadStatus.textContent = "Processing...";

        // 3. Get the public URL
        const downloadURL = await getDownloadURL(snapshot.ref);

        // 4. Save image info to Firestore
        await addDoc(galleryCollectionRef, {
          imageUrl: downloadURL,
          storagePath: storagePath, // Save path for deletion
          uploadedAt: new Date()
        });
        
        // The onSnapshot listener will add it to the page
        uploadStatus.textContent = "Upload complete!";

      } catch (error) {
        console.error("Upload failed: ", error);
        showMessage(`Upload failed: ${error.message}`, "Error");
        uploadStatus.textContent = `Upload failed. Try again.`;
      } finally {
        // Reset input
        uploadInput.value = null; // Clear file input
        uploadLabel.style.display = "inline-block";
        setTimeout(() => {
          uploadStatus.textContent = "";
        }, 3000);
      }
    });

    // --- NEW: Handle Logo Upload ---
    changeLogoButton.addEventListener("click", () => {
      logoUploadInput.click();
    });

    logoUploadInput.addEventListener("change", async () => {
      const file = logoUploadInput.files[0];
      if (!file || !ownerMode) return;

      showMessage("Uploading new logo...", "Updating");
      changeLogoButton.disabled = true;
      changeLogoButton.textContent = "Uploading...";

      try {
        // 1. Upload new logo to Storage
        const newStoragePath = `logo/logo_${Date.now()}_${file.name}`;
        const storageRef = ref(storage, newStoragePath);
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);

        // 2. Delete *old* logo from Storage (if one exists)
        if (currentLogoStoragePath) {
          const oldLogoRef = ref(storage, currentLogoStoragePath);
          try {
            await deleteObject(oldLogoRef);
            console.log("Old logo deleted from storage.");
          } catch (deleteError) {
            console.warn("Could not delete old logo:", deleteError);
          }
        }

        // 3. Update Firestore doc with new logo info
        await updateDoc(logoDocRef, {
          imageUrl: downloadURL,
          storagePath: newStoragePath
        });
        
        // The onSnapshot listener will auto-update the UI
        showMessage("Logo updated successfully!", "Success");
        
      } catch (error) {
        console.error("Logo upload failed:", error);
        showMessage(`Logo upload failed: ${error.message}`, "Error");
      } finally {
        logoUploadInput.value = null; // Clear input
        changeLogoButton.disabled = false;
        changeLogoButton.textContent = "Change Logo";
      }
    });

    // --- Update delete buttons visibility ---
    function updateDeleteButtons() {
      const buttons = document.querySelectorAll(".delete-btn");
      buttons.forEach(btn => {
        btn.style.display = ownerMode ? "block" : "none";
      });
    }

    // --- Firebase Initialization ---
    async function initializeFirebase() {
      try {
        // setLogLevel('debug'); // Enable verbose logging
        // setFirestoreLogLevel('debug');
        
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app); // Initialize Storage

        // This is the collection we will use
        galleryCollectionRef = collection(db, "galleryImages");
        // NEW: This is the single doc for the logo
        logoDocRef = doc(db, "appData", "logo");

        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("User is signed in:", user.uid);
            currentUserId = user.uid;
            userIdDisplay.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;
            
            // Only set up the listener *once* we have a user
            setupRealtimeListener();
            setupLogoListener(); // NEW: Set up the logo listener

            ownerButton.disabled = false;
            ownerButton.textContent = "Owner";

          } else {
            console.log("User is not signed in (state).");
            currentUserId = null;
            userIdDisplay.textContent = "Not signed in";
            
            ownerButton.disabled = true;
            ownerButton.textContent = "Loading...";
            
            ownerMode = false;
            uploadArea.style.display = "none";
            updateDeleteButtons();
          }
        });

        // Sign in anonymously
        console.log("Signing in anonymously...");
        await signInAnonymously(auth);

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        
        if (error.code === 'auth/configuration-not-found') {
            showOnScreenError(
                "ACTION REQUIRED: Authentication not enabled.", 
                "Please go to your Firebase project > Build > Authentication > Sign-in method > and enable the 'Anonymous' provider."
            );
        } else {
            showOnScreenError("Error connecting to app.", error.message);
        }
        
        ownerButton.disabled = true;
        ownerButton.textContent = "Init Error";
      }
    }

    // --- Firestore Real-time Listener ---
    function setupRealtimeListener() {
      if (!galleryCollectionRef) {
        console.error("Firestore collection ref is not set up.");
        return;
      }

      onSnapshot(galleryCollectionRef, (snapshot) => {
        console.log("Got snapshot update!");
        
        if (snapshot.empty) {
            gallery.innerHTML = ''; // Clear gallery
            imagesOnPage.clear();
            if (galleryStatus) {
                galleryStatus.textContent = "No images in gallery yet. Upload one!";
                galleryStatus.style.display = "block";
                galleryStatus.style.color = "#ffb347";
            }
            return;
        }

        // Hide any status message
        if (galleryStatus) galleryStatus.style.display = "none";

        // Track seen docs to handle deletions
        const currentDocIds = new Set();
        
        snapshot.docs.forEach(doc => {
          const docId = doc.id;
          currentDocIds.add(docId);
          const data = doc.data();
          
          // Add image if it's new
          if (!imagesOnPage.has(docId)) {
            console.log("Adding image:", docId);
            addImageToPage(docId, data.imageUrl, data.storagePath);
          }
        });

        // Check for deletions
        imagesOnPage.forEach((element, docId) => {
          if (!currentDocIds.has(docId)) {
            console.log("Removing image:", docId);
            removeImageFromPage(docId);
          }
        });

      }, (error) => {
        console.error("Firestore listener error:", error);
        showOnScreenError("Connection Error.", "Lost connection to the gallery. Please refresh the page.");
      });
    }

    // --- NEW: Firestore Real-time Listener for LOGO ---
    function setupLogoListener() {
      if (!logoDocRef) return;
      
      onSnapshot(logoDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          mainLogoImage.src = data.imageUrl;
          faviconLink.href = data.imageUrl; // Update favicon too
          currentLogoStoragePath = data.storagePath; // Save for deletion
        } else {
          console.log("No logo set. Using placeholder.");
          mainLogoImage.src = placeholderLogoUrl;
          faviconLink.href = placeholderLogoUrl;
          currentLogoStoragePath = null;
        }
      }, (error) => {
        console.error("Error loading logo:", error);
        mainLogoImage.src = placeholderLogoUrl; // Fallback
        faviconLink.href = placeholderLogoUrl;
      });
    }

    // --- START THE APP ---
    initializeFirebase();