<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Levi 3D Print</title>
  
  <style>
    /* General layout */
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      color: white;
      background: linear-gradient(180deg, #ff4500, #ff6600, #ffb347);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Header */
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
    }

    .logo {
      width: 160px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Tabs */
    nav {
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 15px;
      border-radius: 10px;
    }

    nav .tab {
      background: #0a3d62;
      border: none;
      color: white;
      font-size: 16px;
      padding: 8px 18px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    nav .tab:hover,
    nav .tab.active {
      background: #1e90ff;
    }

    /* Main content */
    main {
      text-align: center;
      margin-top: 50px;
      padding-bottom: 60px; /* Add padding to avoid footer overlap */
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    /* Gallery */
    #gallery-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
      min-height: 200px; /* Give it some height for loading state */
    }
    
    #gallery-loading {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .error-message {
        color: #ff9999;
        font-weight: bold;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .image-wrapper {
      position: relative;
      width: 200px;
      height: 200px;
      animation: fadeIn 0.5s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .delete-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(255, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 16px;
      cursor: pointer;
      display: none; /* Controlled by JS */
    }

    .image-wrapper:hover .delete-btn {
      display: block;
    }

    /* Upload area */
    .upload-area {
      margin: 20px;
      display: none; /* Controlled by JS (owner mode) */
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #imageUpload {
      font-size: 14px;
    }

    #uploadBtn {
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: #1e90ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    #uploadBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    
    #upload-status {
      height: 20px;
      margin-top: 5px;
      font-size: 14px;
      color: #ffff99;
    }

    /* Footer */
    footer {
      text-align: center;
      position: absolute;
      bottom: 5px;
      width: 100%;
      font-size: 13px;
      color: white;
    }

    /* Owner button */
    #ownerButton {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      padding: 4px 6px;
      cursor: pointer;
    }
    
    #ownerButton:disabled {
        background: rgba(100, 100, 100, 0.2);
        color: #aaa;
        cursor: not-allowed;
    }
    
    #userIdDisplay {
      position: fixed;
      bottom: 35px;
      left: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      font-family: monospace;
    }

    /* Wave background */
    .wave {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 120%;
      background: linear-gradient(180deg, #ff0000, #ff8c00, #fff, #2a5298);
      clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
      z-index: -1;
      animation: waveMotion 6s ease-in-out infinite alternate;
    }

    @keyframes waveMotion {
      0% {
        clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 95%, 0 90%);
      }
    }
    
    /* Custom Modal for prompts/alerts */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none; /* Show with JS */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #0a3d62;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      text-align: center;
    }
    
    .modal-content p {
      margin: 0 0 15px 0;
      font-size: 18px;
    }
    
    .modal-content input {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #1e90ff;
      font-size: 16px;
      box-sizing: border-box; /* Fix padding issue */
    }
    
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: #1e90ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    .modal-buttons button.cancel {
      background: #555;
    }
    
  </style>
</head>
<body>
  <header>
    <img src="https://placehold.co/160x100/FF6600/FFFFFF?text=Levi+3D" alt="Levi 3D Print Logo" class="logo" />
    <nav>
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="about">About</button>
      <button class="tab" data-tab="gallery">Gallery</button>
    </nav>
  </header>

  <!-- Wave background -->
  <div class="wave"></div>

  <main>
    <section id="home" class="active">
      <h1>Welcome to Levi 3D Print</h1>
      <p>Custom 3D printed creations designed with care and creativity.
      <br>best part: i can customize almost everything!</p>
    </section>

    <section id="about">
      <h1>About Us</h1>
      <p>At Levi 3D Print, we specialize in custom designs and innovative prints made for you.
      <br>I can make earrings toys models cars keychains.
      <br>Contact me on Facebook @ levi's custom 3d printing or email me at levitaba6@icloud.com</p>
    </section>

    <section id="gallery">
      <h1>Gallery</h1>
      <div class="upload-area" id="uploadArea">
        <input type="file" id="imageUpload" accept="image/*" />
        <button id="uploadBtn">Upload</button>
      </div>
      <div id="upload-status"></div>
      <div id="gallery-container">
        <p id="gallery-loading">Loading gallery...</p>
      </div>
    </section>
  </main>

  <footer>
    <p>@Levi3DPrint.com</p>
  </footer>

  <button id="ownerButton" title="Owner Access" disabled>Loading...</button>
  <div id="userIdDisplay"></div>

  <!-- Custom Modal -->
  <div class="modal-overlay" id="customModal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <input type="password" id="modalInput" style="display: none;" />
      <div class="modal-buttons">
        <button id="modalConfirmBtn">OK</button>
        <button id="modalCancelBtn" class="cancel" style="display: none;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
    <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, addDoc, deleteDoc, onSnapshot, 
      collection, setLogLevel 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ------------------------------------------------------------------
    // STEP 1: PASTE YOUR FIREBASE CONFIG HERE
    // ------------------------------------------------------------------
    //
    // Your config has been added!
    //
    const firebaseConfig = {
      apiKey: "AIzaSyAWYZGZ8nvgSAgpQ60OsLqathduMM2CbQE",
      authDomain: "levi3dprint-94bb0.firebaseapp.com",
      projectId: "levi3dprint-94bb0",
      storageBucket: "levi3dprint-94bb0.firebasestorage.app",
      messagingSenderId: "1044564863427",
      appId: "1:1044564863427:web:37017271e5972aee7c3576",
      measurementId: "G-08JB2G438T"
    };
    //
    // ------------------------------------------------------------------

    // --- Element References ---
    const ownerButton = document.getElementById("ownerButton");
    const gallery = document.getElementById("gallery-container");
    const galleryLoading = document.getElementById("gallery-loading");
    const userIdDisplay = document.getElementById("userIdDisplay");
    const tabs = document.querySelectorAll(".tab");
    const sections = document.querySelectorAll("section");
    const uploadArea = document.getElementById("uploadArea");
    const uploadInput = document.getElementById("imageUpload");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadStatus = document.getElementById("upload-status");
    const customModal = document.getElementById("customModal");
    const modalMessage = document.getElementById("modalMessage");
    const modalInput = document.getElementById("modalInput");
    const modalConfirmBtn = document.getElementById("modalConfirmBtn");
    const modalCancelBtn = document.getElementById("modalCancelBtn");

    // --- App Variables ---
    let db, auth;
    let currentUserId = null;
    let galleryCollectionRef = null;
    let ownerMode = false;
    let imageCache = new Map(); // To track images on the page
    let modalConfirmCallback = null;
    
    // --- Helper to show errors on screen ---
    function showOnScreenError(primaryMessage, details = "") {
        if (galleryLoading) {
            galleryLoading.innerHTML = `
                <span class="error-message">
                    <strong>Error:</strong> ${primaryMessage}
                    <br>
                    <small>${details}</small>
                </span>
            `;
            galleryLoading.style.display = "block";
        }
        console.error(primaryMessage, details);
    }

    // --- Modal Functions (Replaces alert/prompt) ---
    function showMessage(message) {
      modalMessage.textContent = message;
      modalInput.style.display = "none";
      modalCancelBtn.style.display = "none";
      modalConfirmBtn.textContent = "OK";
      customModal.style.display = "flex";
      
      modalConfirmCallback = () => {
        customModal.style.display = "none";
      };
    }
    
    function showPasswordPrompt(message, callback) {
      modalMessage.textContent = message;
      modalInput.value = "";
      modalInput.style.display = "block";
      modalCancelBtn.style.display = "inline-block";
      modalConfirmBtn.textContent = "Sign In";
      customModal.style.display = "flex";
      
      modalConfirmCallback = () => {
        const password = modalInput.value;
        customModal.style.display = "none";
        callback(password);
      };
    }
    
    modalConfirmBtn.addEventListener("click", () => {
      if (modalConfirmCallback) {
        modalConfirmCallback();
      }
    });
    
    modalCancelBtn.addEventListener("click", () => {
      customModal.style.display = "none";
    });

    // ======= Tabs =======
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // ======= Owner system =======
    ownerButton.addEventListener("click", () => {
      if (!ownerMode) {
        showPasswordPrompt("Enter owner password:", (password) => {
          if (password === "custom3dlevi") { 
            ownerMode = true;
            showMessage("Owner mode activated!");
            uploadArea.style.display = "flex";
          } else {
            showMessage("Incorrect password! Not signed in.");
            ownerMode = false;
            uploadArea.style.display = "none";
          }
          updateDeleteButtons();
        });
      } else {
        ownerMode = false;
        showMessage("Signed out of Owner mode.");
        uploadArea.style.display = "none";
        updateDeleteButtons();
      }
    });
    
    // Delete button visibility
    function updateDeleteButtons() {
      const deleteButtons = document.querySelectorAll(".delete-btn");
      deleteButtons.forEach(btn => {
        btn.style.display = ownerMode ? "block" : "none";
      });
    }

    // ======= Gallery Functions (Now with Firestore) =======

    // This function adds an image to the page
    function addImageToGallery(docId, src) {
      if (galleryLoading.style.display === "block" && imageCache.size === 0) {
        galleryLoading.style.display = "none";
      }
    
      const wrapper = document.createElement("div");
      wrapper.classList.add("image-wrapper");
      wrapper.setAttribute('data-doc-id', docId); // Store doc ID
      imageCache.set(docId, wrapper); // Add to cache

      const img = document.createElement("img");
      img.src = src;
      img.onerror = () => {
          img.src = 'https://placehold.co/200x200/FF0000/FFFFFF?text=Error';
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "Ã—";
      deleteBtn.classList.add("delete-btn");
      deleteBtn.style.display = ownerMode ? "block" : "none";

      deleteBtn.addEventListener("click", async () => {
        try {
          const docRef = doc(db, 'galleryImages', docId);
          await deleteDoc(docRef);
        } catch (error) {
          console.error("Error deleting document: ", error);
          showMessage("Error: Could not delete image.");
        }
      });

      wrapper.appendChild(img);
      wrapper.appendChild(deleteBtn);
      gallery.appendChild(wrapper);
    }
    
    // This function removes an image from the page
    function removeImageFromGallery(docId) {
      if (imageCache.has(docId)) {
        imageCache.get(docId).remove(); // Remove from DOM
        imageCache.delete(docId); // Remove from cache
      }
      
      if (imageCache.size === 0) {
        galleryLoading.textContent = "No images in gallery yet. Upload one!";
        galleryLoading.style.display = "block";
      }
    }

    // Upload button click listener
    uploadBtn.addEventListener("click", () => {
      if (!ownerMode) {
        showMessage("You must be in Owner mode to upload!");
        return;
      }
      if (!galleryCollectionRef) {
        showMessage("Database not ready, please wait.");
        return;
      }

      const file = uploadInput.files[0];
      if (!file) return;

      if (file.size > 750000) {
        showMessage("Error: Image is too large (max 750KB). Please resize it and try again.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const src = e.target.result; // This is the Base64 data URL
        
        uploadBtn.disabled = true;
        uploadStatus.textContent = "Uploading... please wait.";
        
        try {
          // Add a new document with the image data to Firestore
          await addDoc(galleryCollectionRef, {
            src: src,
            uploadedAt: new Date()
          });
          uploadStatus.textContent = "Upload successful!";
          uploadInput.value = null; // Clear file input
        } catch (error) {
          console.error("Error adding document: ", error);
          showMessage("Error: Upload failed. The file might be too large.");
          uploadStatus.textContent = "Upload failed.";
        } finally {
          uploadBtn.disabled = false;
          setTimeout(() => { uploadStatus.textContent = ""; }, 3000);
        }
      };
      
      reader.onerror = () => {
          showMessage("Error reading file.");
      };
      
      reader.readAsDataURL(file);
    });
    
    // --- Firebase Initialization ---
    async function initializeFirebase() {
      // Check if the user has pasted their config
      if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
          showOnScreenError(
              "Configuration Missing",
              "You must paste your own 'firebaseConfig' object into the index.html file to connect to the database."
          );
          ownerButton.disabled = true;
          ownerButton.textContent = "Config Error";
          return;
      }

      try {
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("User is signed in:", user.uid);
            currentUserId = user.uid;
            userIdDisplay.textContent = `ID: ${currentUserId.substring(0, 8)}...`;
            
            setupRealtimeListener();

            ownerButton.disabled = false;
            ownerButton.textContent = "Owner";

          } else {
            console.log("User is signed out or auth failed.");
            currentUserId = null;
            userIdDisplay.textContent = "Not signed in";
            
            ownerButton.disabled = true;
            ownerButton.textContent = "Auth Failed";
            showOnScreenError("Authentication Failed.", "You are not signed in. Gallery cannot be loaded.");
            ownerMode = false;
            uploadArea.style.display = "none";
            updateDeleteButtons();
          }
        });

        // Sign in anonymously
        console.log("Signing in anonymously...");
        await signInAnonymously(auth);

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        
        if (error.code === 'auth/configuration-not-found') {
            showOnScreenError(
                "ACTION REQUIRED: Authentication not enabled.",
                "Please go to your Firebase project > Build > Authentication > Sign-in method > and enable the 'Anonymous' provider."
            );
        } else {
            showOnScreenError("Error connecting to app.", error.message);
        }
        
        ownerButton.disabled = true;
        ownerButton.textContent = "Init Error";
      }
    }

    // --- Firestore Real-time Listener ---
    function setupRealtimeListener() {
      if (!db || !currentUserId) {
        showOnScreenError("Cannot load gallery.", "Database or User ID not ready.");
        return;
      }
      
      // I've simplified this path. This will now look for a collection
      // named 'galleryImages' at the root of your database.
      galleryCollectionRef = collection(db, 'galleryImages');
      console.log("Listening for changes in:", galleryCollectionRef.path);

      onSnapshot(galleryCollectionRef, (snapshot) => {
        
        if (snapshot.empty) {
            galleryLoading.textContent = "No images in gallery yet. Upload one!";
            galleryLoading.style.display = "block";
            gallery.querySelectorAll('.image-wrapper').forEach(w => w.remove());
            imageCache.clear();
        } else {
            galleryLoading.style.display = "none";
        }
        
        snapshot.docChanges().forEach((change) => {
          const docId = change.doc.id;
          const docData = change.doc.data();

          if (change.type === "added") {
            if (!imageCache.has(docId)) {
                addImageToGallery(docId, docData.src);
            }
          }
          if (change.type === "removed") {
            removeImageFromGallery(docId);
          }
        });
        
        updateDeleteButtons();

      }, (error) => {
        console.error("Snapshot listener error:", error);
        showOnScreenError(
            "Permission Denied or Connection Lost.",
            `The gallery cannot be loaded. (Code: ${error.code})`
        );
      });
    }

    // --- START THE APP ---
    // We no longer need to poll, just run the init function
    initializeFirebase();

  </script>
</body>
</html>